# LL3M Setup Scripts

This directory contains setup and utility scripts for local development with LL3M.

## Scripts Overview

### `blender_mcp_setup.py`
Main setup script that configures the entire local development environment.

**Features:**
- ✅ Detects Blender installation on macOS
- ✅ Installs required Python packages in Blender's environment  
- ✅ Creates Blender MCP server script
- ✅ Generates startup and test scripts
- ✅ Creates environment configuration template

**Usage:**
```bash
python setup/blender_mcp_setup.py
```

### `blender_mcp_server.py`
FastAPI server that runs inside Blender to enable remote code execution.

**Endpoints:**
- `GET /health` - Health check
- `POST /execute` - Execute Python code in Blender
- `GET /scene/info` - Get scene information
- `POST /scene/save` - Save Blender scene

**Auto-generated by:** `blender_mcp_setup.py`

### `start_blender_mcp.sh`
Bash script to start Blender with the MCP server.

**Usage:**
```bash
# Start with default port (3001)
./setup/start_blender_mcp.sh

# Start with custom port
./setup/start_blender_mcp.sh 3002
```

### `test_blender_mcp.py`
Test script to verify Blender MCP integration is working correctly.

**Tests:**
- ✅ Health endpoint connectivity
- ✅ Code execution functionality
- ✅ Scene information retrieval  
- ✅ Error handling

**Usage:**
```bash
# Make sure Blender MCP server is running first
./setup/start_blender_mcp.sh

# Then run tests in another terminal
./setup/test_blender_mcp.py
```

## Quick Start

1. **Run the main setup:**
   ```bash
   python setup/blender_mcp_setup.py
   ```

2. **Configure environment:**
   ```bash
   cp .env.local .env
   # Edit .env as needed
   ```

3. **Start LM Studio:**
   - Launch LM Studio app
   - Download and load a model  
   - Start the server in Developer tab

4. **Start Blender MCP server:**
   ```bash
   ./setup/start_blender_mcp.sh
   ```

5. **Test the setup:**
   ```bash
   ./setup/test_blender_mcp.py
   ```

6. **Run E2E tests:**
   ```bash
   python -m pytest tests/e2e/ -v -s
   ```

## Configuration Files Generated

### `.env.local`
Template environment file with all necessary configuration:

```env
# LLM Configuration
USE_LOCAL_LLM=true
LMSTUDIO_BASE_URL=http://localhost:1234/v1

# Blender Configuration  
BLENDER_PATH=/Applications/Blender.app/Contents/MacOS/Blender
BLENDER_MCP_SERVER_URL=http://localhost:3001

# Development Settings
DEVELOPMENT=true
DEBUG=true
```

### Blender Startup Scripts
- `start_blender_mcp.sh` - Launches Blender with MCP server
- `blender_mcp_server.py` - FastAPI server code for Blender

## Troubleshooting

### Setup Issues

**Blender not found:**
```bash
# Check if Blender is installed
ls /Applications/Blender.app/Contents/MacOS/Blender

# If not found, download from https://www.blender.org/download/
```

**Permission denied:**
```bash
# Make scripts executable
chmod +x setup/*.sh
chmod +x setup/*.py
```

**Package installation fails:**
```bash
# Manually install packages in Blender
/Applications/Blender.app/Contents/MacOS/Blender --background --python-expr "
import subprocess, sys
subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'fastapi'])
"
```

### Runtime Issues

**MCP server won't start:**
```bash
# Check Blender path in .env
echo $BLENDER_PATH

# Test Blender manually
/Applications/Blender.app/Contents/MacOS/Blender --version

# Check port availability
lsof -i :3001
```

**LM Studio connection fails:**
```bash
# Verify LM Studio server is running
curl http://localhost:1234/v1/models

# Check if model is loaded in LM Studio
```

**Tests fail:**
```bash
# Check prerequisites
python tests/e2e/conftest.py

# Run individual test components
python -m pytest tests/e2e/test_llm_integration.py -v
python -m pytest tests/e2e/test_blender_integration.py -v
```

## Advanced Configuration

### Custom Blender Installation
If Blender is installed in a non-standard location:

```bash
# Set custom path before setup
export BLENDER_PATH="/usr/local/bin/blender"
python setup/blender_mcp_setup.py
```

### Custom Ports
To use different ports:

```bash
# Start MCP server on custom port
./setup/start_blender_mcp.sh 3002

# Update .env file
BLENDER_MCP_SERVER_PORT=3002
BLENDER_MCP_SERVER_URL=http://localhost:3002
```

### Multiple Blender Versions
For testing with multiple Blender versions:

```bash
# Setup for specific version
BLENDER_PATH="/Applications/Blender-3.6.app/Contents/MacOS/Blender" \
python setup/blender_mcp_setup.py
```

## Integration with IDEs

### VS Code
Add to `.vscode/launch.json`:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "LL3M E2E Tests",
            "type": "python",
            "request": "launch",
            "module": "pytest",
            "args": ["tests/e2e/", "-v", "-s"],
            "env": {
                "USE_LOCAL_LLM": "true",
                "DEVELOPMENT": "true"
            }
        }
    ]
}
```

### PyCharm
1. Create run configuration for pytest
2. Set module: `pytest`  
3. Parameters: `tests/e2e/ -v -s`
4. Environment variables:
   - `USE_LOCAL_LLM=true`
   - `DEVELOPMENT=true`

## Monitoring and Debugging

### Logs
- **Blender MCP Server:** Check terminal output when running `start_blender_mcp.sh`
- **LM Studio:** Monitor LM Studio console for API requests
- **LL3M Application:** Set `LOG_LEVEL=DEBUG` in `.env`

### Performance
- **Model Loading:** Use smaller models (7B) for faster responses
- **Blender Timeout:** Increase `BLENDER_TIMEOUT` for complex scenes
- **Memory Usage:** Monitor system memory when running large models

### Health Checks
```bash
# Quick health check script
curl -s http://localhost:3001/health | jq .
curl -s http://localhost:1234/v1/models | jq '.data[].id'
```

## Contributing

When modifying setup scripts:

1. Test on clean macOS environment
2. Update this README with changes
3. Verify all generated files are correct
4. Test both automated and manual setup processes
5. Update troubleshooting section for new issues

## Files Generated by Setup

After running `blender_mcp_setup.py`:

```
setup/
├── blender_mcp_server.py    # Blender FastAPI server
├── start_blender_mcp.sh     # Startup script
└── test_blender_mcp.py      # Test script

.env.local                   # Environment template
```

Copy `.env.local` to `.env` and customize as needed for your setup.